<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <% include head %>
        <title>Chat Bot</title>
        <link href="../css/chat.css" type="text/css" rel="stylesheet">
</head>

<body style="background-image: url('../images/background.png'); background-size: 100%; background-repeat: repeat-y;">
    <div class="container">
        <h3 class=" text-center">Chat Bot</h3>
        <div class="messaging">
            <div class="inbox_msg" style="background-color: white">
                <div class="inbox_people">
                    <div class="headind_srch">
                        <div class="recent_heading">
                            <h4>Recent</h4>
                        </div>
                        <div class="srch_bar">
                            <div class="stylish-input-group">
                                <input type="text" class="search-bar" placeholder="Search">
                                <span class="input-group-addon">
                                    <button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="inbox_chat">
                        <div class="chat_list active_chat">
                            <div class="chat_people">
                                <div class="chat_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
                                <div class="chat_ib">
                                    <h5>Bot chat <span class="chat_date"><%= date() %></span></h5>
                                    <p id=l ast_message></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mesgs">
                    <div class="msg_history" id="msg_history">
                    </div>
                    <div class="type_msg">
                        <div class="input_msg_write">
                            <input type="text" class="write_msg" placeholder="Type a message" id="write_msg" />
                            <button class="msg_send_btn" type="button" onclick="sendMessage()"><img src="../images/enviar.png" alt="Send message" title="Send message"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    document.onkeyup = function(event) {
        if (event.keyCode == 13) {
            sendMessage()
        }
    }

    function sendMessage() {
        let message = document.getElementById("write_msg")
        let msg_history = document.getElementById("msg_history")
        let last_message = document.getElementById("last_message")

        if (message.value != "") {
            let outgoin_msg = document.createElement("div")
            let sent_msg = document.createElement("div")
            let p = document.createElement("p")
            let span = document.createElement("span")
            let time = new Date()

            outgoin_msg.className += "outgoin_msg"
            sent_msg.className += "sent_msg"
            span.className = "time_date"

            span.textContent = time.getHours() + ":" + time.getMinutes()
            p.textContent = message.value

            sent_msg.appendChild(p)
            sent_msg.appendChild(span)
            outgoin_msg.appendChild(sent_msg)
            msg_history.appendChild(outgoin_msg)

            //last_message.innerText = message.value
            //message.value = ""

            reciveMessage()
        }
    }

    function reciveMessage() {
        userMessage = document.getElementById("write_msg").value
        let messageObject = {
            msg: userMessage
        }

        $.ajax({
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(messageObject),
            url: "/send"

        }).done((bot_resp) => {
            let message = bot_resp
            let msg_history = document.getElementById("msg_history")
            let last_message = document.getElementById("last_message")

            let incoming_msg = document.createElement("div")
            let incoming_msg_img = document.createElement("div")
            let received_msg = document.createElement("div")
            let received_withd_msg = document.createElement("div")
            let p = document.createElement("p")
            let span = document.createElement("span")
            let time = new Date()

            incoming_msg.className += "incoming_msg"
            incoming_msg_img.className += "incoming_msg_img"
            received_msg.className += "received_msg"
            received_withd_msg.className += "received_withd_msg"
            span.className += "time_date"

            span.textContent = time.getHours() + ":" + time.getMinutes()
            p.textContent = message

            received_withd_msg.appendChild(p)
            received_withd_msg.appendChild(span)
            received_msg.appendChild(received_withd_msg)
            incoming_msg.appendChild(incoming_msg_img)
            incoming_msg.appendChild(received_msg)
            msg_history.appendChild(incoming_msg)
            msg_history.scrollTo(0,msg_history.scrollHeight)
            //last_message.textContent = message

            document.getElementById("write_msg").value = ""
        })



    }
</script>

</html>
<%
function date(){
    let date = new Date()
    switch(date.getMonth()){
        case 0 : return "Jan " + date.getDate()
        case 1 : return "Feb "+ date.getDate()
        case 2 : return "Mar "+ date.getDate()
        case 3 : return "Apr "+ date.getDate()
        case 4 : return "May "+ date.getDate()
        case 5 : return "Jun "+ date.getDate()
        case 6 : return "Jul "+ date.getDate()
        case 7 : return "Aug "+ date.getDate()
        case 8 : return "Sep "+ date.getDate()
        case 9 : return "Oct "+ date.getDate()
        case 10 : return "Nov "+ date.getDate()
        case 11 : return "Dec "+ date.getDate()
    }
}

%>